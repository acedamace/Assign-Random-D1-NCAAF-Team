<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Randomly Assign NCAAF D1 Teams</title>
<style>
  :root { --bg:#0b1020; --card:#141a2e; --text:#e8ebff; --muted:#a9afd1; --accent:#7aa2ff; --ok:#79ffa1; --warn:#ffd479; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 14px;font-size:28px;text-align:center}

  .grid{display:grid;grid-template-columns: 1fr 1fr; gap:14px}
  @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:12px;color:#a9afd1}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}

  /* Managers: auto height (no scrollbar) */
  .box-managers{border:1px solid #2a3252;border-radius:10px;padding:10px;background:#0f1530}
  ul.managers{margin:0;padding-left:20px;line-height:1.4}
  ul.managers li{margin:2px 0}

  /* Teams: revert to earlier smaller height; scroll fills its card */
  .box-teams{height:34vh;overflow:auto;border:1px solid #2a3252;border-radius:10px;padding:10px;background:#0f1530}
  ol.teamlist{margin:0;padding-left:36px;line-height:1.25}
  ol.teamlist li{padding:2px 6px;border-radius:8px;white-space:nowrap; list-style: decimal}
  ol.teamlist li.hit{background:rgba(122,162,255,.18);outline:1px solid rgba(122,162,255,.35);font-weight:600}

  /* Output: height auto-adjusts to content (set via JS) */
  .wide{grid-column: 1 / span 2;}
  .out{font-family:ui-monospace,Consolas,Menlo,monospace;background:#0f1530;border:1px solid #2a3252;border-radius:10px;padding:12px;overflow:auto;white-space:pre}

  /* Footer controls */
  .controlsFooter{margin-top:8px;background:#0f1530;border:1px solid #2a3252;border-radius:12px;padding:10px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;justify-content:center}
  .btn{background:#1d2544;color:var(--text);border:1px solid #2a3252;border-radius:10px;padding:10px 14px;cursor:pointer;transition:.15s transform ease,.15s opacity ease}
  .btn:hover{transform:translateY(-1px);opacity:.95}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.primary{background:var(--accent);color:#0a0e1f;border-color:#5b86ff}
  .btn.on{outline:2px solid var(--ok);box-shadow:0 0 0 4px rgba(121,255,161,.12) inset}
  .btn.finalizing{outline:2px solid var(--warn);box-shadow:0 0 0 4px rgba(255,212,121,.12) inset}

  /* Host-only speed controls (hidden for others) */
  #speedRow{display:none;margin-top:10px}
  .row{display:flex;gap:12px}
  .pill{background:#101736;border:1px solid #2a3252;padding:8px 10px;border-radius:10px}

  .countdown{font-weight:700;color:var(--warn)}
  .center{ text-align:center }
</style>
</head>
<body>
<div class="wrap">
  <h1>Randomly Assign NCAAF D1 Teams</h1>

  <div class="grid">
    <!-- Left: Managers -->
    <div class="card">
      <div class="muted">Managers</div>
      <div class="box-managers">
        <ul id="managersList" class="managers"></ul>
      </div>

      <!-- Host-only global speed -->
      <div id="speedRow" class="row">
        <div class="pill" style="flex:1">
          <div class="muted">Speed (ms/char)</div>
          <input id="speed" type="range" min="5" max="120" value="30" style="width:100%"/>
        </div>
        <div class="pill" style="flex:1">
          <div class="muted">Pause between lines (ms)</div>
          <input id="linePause" type="number" min="0" value="250" style="width:100%"/>
        </div>
      </div>
    </div>

    <!-- Right: Teams -->
    <div class="card">
      <div class="muted">12 of 265 NCAAF D1 Teams will be randomly selected.</div>
      <div class="box-teams">
        <ol id="teamList" class="teamlist mono"></ol>
      </div>
    </div>

    <!-- Output -->
    <div class="card wide">
      <div class="muted">Output <span id="cooldown" class="countdown"></span></div>
      <div id="out" class="out"></div>
    </div>
  </div>

  <!-- FOOTER: controls + status -->
  <div class="controlsFooter">
    <div class="controls">
      <button id="start"    class="btn">Start</button>
      <button id="begin"    class="btn primary" disabled>Begin</button>
      <button id="drawOnce" class="btn">Draw Once</button>
      <button id="finalize" class="btn" disabled>Finalize</button>
      <button id="clear"    class="btn" style="display:none">Clear</button>
      <button id="copy"     class="btn">Copy</button>
      <button id="csv"      class="btn">Export CSV</button>
    </div>
    <div class="small center" id="status">Connectingâ€¦</div>
    <div class="small center" id="audience"></div>
    <div class="small center">Hotkeys: <b>Space</b> Begin/stop (Executor) â€¢ <b>R</b> Draw Once</div>
  </div>
</div>

<script type="module">
  /* ===================== FIXED DATA (READ-ONLY) ===================== */
  // ðŸ‘‰ Paste your exact 265-name University/College list here. Keep it at 265.
  const TEAMS = [
"Abilene Christian University","Alabama A&M University","Alabama State University","Alcorn State University","Appalachian State University","Arizona State University",
  "Arkansas State University","Auburn University","Austin Peay State University","Ball State University","Baylor University","Bethune-Cookman University",
  "Boise State University","Boston College","Bowling Green State University","Brigham Young University","Brown University","Bryant University",
  "Bucknell University","Butler University","California Polytechnic State University â€“ San Luis Obispo","California State University â€“ Fresno","California State University â€“ Sacramento",
  "Campbell University","Central Connecticut State University","Central Michigan University","Charleston Southern University","Clemson University",
  "Coastal Carolina University","Colgate University","College of the Holy Cross","Colorado State University","Columbia University","Cornell University",
  "Cottey College","Dartmouth College","Davidson College","Delaware State University","Drake University","Duke University","Duquesne University",
  "East Carolina University","East Tennessee State University","Eastern Illinois University","Eastern Kentucky University","Eastern Michigan University",
  "Eastern Washington University","Elon University","Florida A&M University","Florida Atlantic University","Florida International University","Florida State University",
  "Fordham University","Formerly Dixie State University","Furman University","Gardner-Webb University","Georgetown University","Georgia Southern University",
  "Georgia State University","Georgia Tech","Grambling State University","Hampton University","Harvard University","Houston Christian University","Howard University",
  "Idaho State University","Illinois State University","Indiana State University","Indiana University","Iowa State University","Jackson State University","Jacksonville State University",
  "James Madison University","Kansas State University","Kennesaw State University","Kent State University","Lafayette College","Lamar University","Lehigh University",
  "Liberty University","Lindenwood University","Long Island University","Louisiana State University (LSU)","Louisiana Tech University","Marist College","Marshall University",
  "McNeese State University","Mercer University","Mercyhurst University","Merrimack College","Miami University","Michigan State University","Middle Tennessee State University",
  "Mississippi State University","Mississippi Valley State University","Missouri State University","Monmouth University","Montana State University","Morehead State University",
  "Morgan State University","Murray State University","New Mexico State University","Nicholls State University","Norfolk State University","North Carolina A&T State University",
  "North Carolina Central University","North Carolina State University","North Dakota State University","Northern Arizona University","Northern Illinois University",
  "Northwestern State University of Louisiana","Northwestern University","Ohio State University","Ohio University","Oklahoma State University","Old Dominion University",
  "Oregon State University","Penn State","Portland State University","Prairie View A & M University","Presbyterian College","Princeton University","Purdue University",
  "Rice University","Robert Morris University â€“ Pennsylvania","Rutgers University","Sacred Heart University","Saint Francis University","Sam Houston State University",
  "Samford University","San Diego State University","San Jose State University","South Carolina State University","South Dakota State University","Southeast Missouri State University",
  "Southeastern Louisiana University","Southern Illinois University Carbondale","Southern Methodist University â€“ SMU","Southern University & A&M College","Southern Utah University",
  "Stanford University","Stephen F Austin State University","Stetson University","Stonehill College","SUNY Stony Brook University","SUNY University at Albany","SUNY University at Buffalo",
  "Syracuse University","Tarleton State University","Temple University","Tennessee State University","Tennessee Technological University","Texas A&M University","Texas A&M University â€“ Commerce",
  "Texas Christian University","Texas Southern University","Texas State University","Texas Tech University","The Citadel","Towson University","Troy University","Tulane University",
  "United States Air Force Academy","United States Military Academy","United States Naval Academy","University of Akron","University of Alabama","University of Alabama â€“ Birmingham",
  "University of Arizona","University of Arkansas","University of Arkansas at Pine Bluff","University of California â€“ Berkeley","University of California â€“ Davis",
  "University of California â€“ Los Angeles â€“ UCLA","University of Central Arkansas","University of Central Florida","University of Cincinnati","University of Colorado â€“ Boulder",
  "University of Connecticut","University of Dayton","University of Delaware","University of Florida","University of Georgia","University of Hawaii at Manoa","University of Houston",
  "University of Idaho","University of Illinois","University of Iowa","University of Kansas","University of Kentucky","University of Louisiana","University of Louisiana â€“ Monroe",
  "University of Louisville","University of Maine","University of Maryland","University of Massachusetts â€“ Amherst","University of Memphis","University of Miami","University of Michigan",
  "University of Minnesota","University of Mississippi","University of Missouri","University of Montana","University of Nebraska","University of Nevada â€“ Las Vegas","University of Nevada â€“ Reno",
  "University of New Hampshire","University of New Mexico","University of North Alabama","University of North Carolina at Chapel Hill","University of North Carolina at Charlotte",
  "University of North Dakota","University of North Texas","University of Northern Colorado","University of Northern Iowa","University of Notre Dame","University of Oklahoma",
  "University of Oregon","University of Pennsylvania â€“ Penn","University of Pittsburgh","University of Rhode Island","University of Richmond","University of San Diego",
  "University of South Alabama","University of South Carolina","University of South Dakota","University of South Florida","University of Southern California","University of Southern Mississippi",
  "University of St. Thomas â€“ Minnesota","University of Tennessee","University of Tennessee â€“ Chattanooga","University of Tennessee â€“ Martin","University of Texas â€“ Austin",
  "University of Texas â€“ El Paso","University of Texas â€“ Rio Grande Valley","University of Texas â€“ San Antonio","University of the Incarnate Word","University of Toledo",
  "University of Tulsa","University of Utah","University of Virginia","University of Washington","University of West Georgia","University of Wisconsin","University of Wyoming",
  "Utah State University","Valparaiso University","Vanderbilt University","Villanova University","Virginia Military Institute â€“ VMI","Virginia Tech","Wagner College","Wake Forest University",
  "Washington State University","Weber State University","West Virginia University","Western Carolina University","Western Illinois University","Western Kentucky University",
  "Western Michigan University","William & Mary","Wofford College","Yale University","Youngstown State University"Â Â Â Â Â Â Â Â Â Â Â  
];

  // Managers (12)
  const MANAGERS = ["AP","AW","CR","JW","MS","LL","Josh","FAB","JJ","EJ","DA","CO"];
  /* ================================================================== */

  // ---------- Firebase (CDN) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getDatabase, ref, onValue, get, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAmgCkDpIN-YNALQOb8HTb7WJn1bX0i9qA",
    authDomain: "draft-sync.firebaseapp.com",
    databaseURL: "https://draft-sync-default-rtdb.firebaseio.com",
    projectId: "draft-sync",
    storageBucket: "draft-sync.firebasestorage.app",
    messagingSenderId: "234722685207",
    appId: "1:234722685207:web:abc660fa65a105ecdbc752"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getDatabase(app);

  // ---------- UI refs ----------
  const out = document.getElementById('out');
  const teamList = document.getElementById('teamList');
  const managersList = document.getElementById('managersList');
  const statusEl = document.getElementById('status');
  const audEl = document.getElementById('audience');
  const speedRow = document.getElementById('speedRow');
  const speedEl = document.getElementById('speed');
  const pauseEl = document.getElementById('linePause');
  const startBtn = document.getElementById('start');
  const beginBtn = document.getElementById('begin');
  const drawOnceBtn = document.getElementById('drawOnce');
  const finalizeBtn = document.getElementById('finalize');
  const clearBtn = document.getElementById('clear');
  const copyBtn = document.getElementById('copy');
  const csvBtn = document.getElementById('csv');
  const cooldownEl = document.getElementById('cooldown');

  // ---------- helpers ----------
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  function shuffle(a){ a=a.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
  function pick12(n){ const idx=[...Array(n).keys()].map(i=>i+1); return shuffle(idx).slice(0,12).sort((a,b)=>a-b); }
  const pad3 = (n)=>String(n).padStart(3,' ');
  const formatLine = (m, num, team)=>`${m.padEnd(10)} -> ${pad3(num)} - ${team}\n`; // single trailing \n

  function adjustOutputHeight(){
    // Fit height to content (with caps)
    const style = getComputedStyle(out);
    const lineH = parseFloat(style.lineHeight) || 18;
    const padding = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom);
    const lines = Math.max(1, out.textContent.split('\n').length);
    const px = Math.min(Math.max(lines * lineH + padding, 140), 560); // min 140px, max 560px
    out.style.height = px + 'px';
  }

  // Render static lists
  managersList.innerHTML = MANAGERS.map(m=>`<li>${m}</li>`).join('');
  teamList.innerHTML = TEAMS.map((t,i)=> `<li data-num="${i+1}">${t}</li>`).join('');

  // ---------- global state ----------
  let myUID=null, myName="Viewer";
  let isHost=false, isExecutor=false, isFinalizer=false;
  let globalSpeedMs=30, globalLinePauseMs=250;
  let localIsController=false;
  let localContinuous=false;
  let localFinalizeRequested=false;
  let fastForward = false; // fast-finish Draw Once
  let hasBegun = false;    // enables Finalize only after Begin

  // renderer guards
  let animating = false;
  let activeSeq = null;
  let latestRenderSeq = null;

  // cooldown timer singleton
  let cooldownTimer = null;

  // ---------- auth ----------
  onAuthStateChanged(auth, async (user)=>{
    if (!user){ await signInAnonymously(auth); return; }
    myUID = user.uid;
    await ensureDisplayName();
    await bootstrapHostIfNamed();
    await readMyRole();
    statusEl.textContent = `${(isHost?'HOST':isExecutor?'EXECUTOR':isFinalizer?'FINALIZER':'VIEWER')}: ${myName} (${myUID.slice(0,8)}â€¦)`;
    wireUIForRole();
  });

  async function ensureDisplayName(){
    const s = await get(ref(db, `users/${myUID}`));
    const existing = s.exists() ? s.val().displayName : null;
    if (existing){ myName = existing; return; }
    let name = (prompt("Enter your name or initials:")||"").trim().slice(0,24);
    if (!name) name="Viewer";
    await set(ref(db, `users/${myUID}`), { displayName: name, joinedAt: Date.now() });
    myName = name;
  }

  // Bootstrap AceDaAdmin if roles empty
  async function bootstrapHostIfNamed(){
    const rolesSnap = await get(ref(db,'roles'));
    const rolesVal = rolesSnap.exists()? rolesSnap.val():{};
    const noneSet = !rolesVal || (!rolesVal.hostUid && !rolesVal.executorUid && !rolesVal.finalizerUid);
    if (myName === "AceDaAdmin" && noneSet){
      await runTransaction(ref(db,'roles'), (cur)=>{
        if (cur && (cur.hostUid || cur.executorUid || cur.finalizerUid)) return;
        return { hostUid: myUID, executorUid: myUID, finalizerUid: myUID };
      });
    }
  }

  async function readMyRole(){
    const r = await get(ref(db,`roles`)); const val = r.exists()? r.val():{};
    isHost = val.hostUid === myUID;
    isExecutor = val.executorUid === myUID;
    isFinalizer = val.finalizerUid === myUID;
  }

  function wireUIForRole(){
    startBtn.disabled = !isHost;
    beginBtn.disabled = true;
    finalizeBtn.disabled = true;
    drawOnceBtn.disabled = false;
    clearBtn.style.display = isHost ? '' : 'none';
    speedRow.style.display = isHost ? '' : 'none';
  }

  // Live roles listener
  onValue(ref(db,'roles'), (snap)=>{
    const val = snap.val()||{};
    isHost = val.hostUid === myUID;
    isExecutor = val.executorUid === myUID;
    isFinalizer = val.finalizerUid === myUID;
    clearBtn.style.display = isHost ? '' : 'none';
    speedRow.style.display = isHost ? '' : 'none';
  });

  // ---------- settings (global speed) ----------
  onValue(ref(db,'settings'), (snap)=>{
    const s = snap.val()||{};
    if (typeof s.speedMs === 'number') globalSpeedMs = s.speedMs;
    if (typeof s.linePauseMs === 'number') globalLinePauseMs = s.linePauseMs;
    if (isHost){ speedEl.value = globalSpeedMs; pauseEl.value = globalLinePauseMs; }
  });
  const saveGlobalSpeed = ()=>{ if (!isHost) return; update(ref(db,'settings'), {
    speedMs: Number(speedEl.value||30), linePauseMs: Number(pauseEl.value||250)
  }); };
  speedEl.addEventListener('change', saveGlobalSpeed);
  pauseEl.addEventListener('change', saveGlobalSpeed);

  // ---------- live users ----------
  onValue(ref(db,'users'), (snap)=>{
    const users = snap.val()||{};
    const list = Object.entries(users).map(([uid,u])=>`${(u.displayName||'Viewer')} â€” ${uid.slice(0,8)}â€¦`);
    audEl.textContent = 'Connected: ' + (list.length ? list.join(' | ') : 'â€”');
  });

  // ========== UI LISTENER (cooldown, buttons, highlights) ==========
  onValue(ref(db,'state'), async (snap)=>{
    const s = snap.val()||{};
    const now = Date.now();
    const until = s.cooldownUntil||0;

    // sync flags for UI & renderer
    fastForward = !!s.fastForward;
    hasBegun = !!s.hasBegun;
    latestRenderSeq = s.renderSeq ?? latestRenderSeq;

    // Cooldown
    if (now < until){
      if (!cooldownTimer){
        const tick = ()=>{
          const n = Date.now();
          const secs = Math.max(0, Math.ceil((until - n)/1000));
          cooldownEl.textContent = ` â€” Finalized. Controls unlock in ${secs}s`;
          if (n >= until){
            cooldownEl.textContent='';
            clearInterval(cooldownTimer);
            cooldownTimer = null;
            wireUIForRole();
          }
        };
        cooldownTimer = setInterval(tick, 500);
        tick();
      }
      startBtn.disabled = beginBtn.disabled = drawOnceBtn.disabled = finalizeBtn.disabled = clearBtn.disabled = true;
    } else {
      cooldownEl.textContent='';
      const mode = s.controlMode || 'drawonce';
      const running = !!s.running;
      const runningOnce = running && s.mode === 'once';
      const finalized = !!s.finalizedAt;

      // Base gating
      startBtn.disabled   = !isHost || runningOnce || running;                 // disabled during any running draw
      beginBtn.disabled   = !(mode === 'begin' && isExecutor) || runningOnce || running; // no begin during running
      drawOnceBtn.disabled= (mode === 'begin') && !runningOnce ? true : false; // disabled in begin-mode unless we're already in a once-run
      if (runningOnce) drawOnceBtn.disabled = false; // allow fast-forward

      // Finalize only after Begin
      finalizeBtn.disabled = !(hasBegun && isFinalizer) || runningOnce;

      // Clear (host-only): disabled after Start (i.e., when in begin-mode or hasBegun), disabled during Draw Once, re-enabled after cooldown
      clearBtn.disabled = !isHost || runningOnce || mode === 'begin' || hasBegun;

      // Confirm prompts (only if finalizedAt exists) are handled in the button handlers
    }

    // controller + team highlights
    localIsController = (s.controllerUid === myUID);
    document.querySelectorAll('#teamList li.hit').forEach(li=>li.classList.remove('hit'));
    (Array.isArray(s.picks)? s.picks:[]).forEach(n=>{
      const li = document.querySelector(`#teamList li[data-num="${n}"]`);
      if (li) li.classList.add('hit');
    });

    // Visual reset when stopped
    if (!s.running){
      localContinuous=false; localFinalizeRequested=false;
      beginBtn.classList.remove('on'); finalizeBtn.classList.remove('finalizing');
    }
  });

  // ========== RENDERER (types output once per draw; checks new cycle only between lines) ==========
  onValue(ref(db,'state'), async (snap)=>{
    const s = snap.val()||{};
    const running   = !!s.running;
    const picks     = Array.isArray(s.picks) ? s.picks : [];
    const managers  = Array.isArray(s.managers) ? s.managers : [];
    const renderSeq = s.renderSeq ?? null;
    const mode      = s.mode || 'once';
    const spd       = typeof s.speedMsSnapshot === 'number' ? s.speedMsSnapshot : globalSpeedMs;
    const pause     = typeof s.linePauseMsSnapshot === 'number' ? s.linePauseMsSnapshot : globalLinePauseMs;

    if (!running || !picks.length || !managers.length) return;
    if (animating) return;
    if (renderSeq && renderSeq === activeSeq) return;

    // lock
    animating = true;
    activeSeq = renderSeq;

    out.textContent = "Random Assignments:\n";
    adjustOutputHeight();

    // Fast-forward immediately if requested for once-mode
    if (fastForward && mode === 'once'){
      const block = picks.map((p,i)=>formatLine(managers[i], p, TEAMS[p-1]||"??")).join('');
      out.textContent += block;
      adjustOutputHeight();
      if (localIsController){
        const prev = (await get(ref(db,'state'))).val()||{};
        const cyc = (prev.cyclesCompleted||0)+1;
        await update(ref(db,'state'), { running:false, fastForward:false, cyclesCompleted:cyc });
      }
      animating = false;
      return;
    }

    for (let i=0;i<Math.min(picks.length, managers.length);i++){
      const idx = picks[i]-1;
      const line = formatLine(managers[i], picks[i], TEAMS[idx] || "??");
      for (let j=0;j<line.length;j++){
        out.textContent += line[j];
        // no per-char renderSeq abort for continuous; avoids mid-line cutoffs
        if (mode === 'once' && fastForward){
          // if fast-forward toggled mid-line for once, dump remainder
          const block = picks.map((p,k)=>formatLine(managers[k], p, TEAMS[p-1]||"??")).join('');
          out.textContent = "Random Assignments:\n" + block;
          adjustOutputHeight();
          if (localIsController){
            const cur = (await get(ref(db,'state'))).val()||{};
            const cyc = (cur.cyclesCompleted||0)+1;
            await update(ref(db,'state'), { running:false, fastForward:false, cyclesCompleted:cyc });
          }
          animating = false;
          return;
        }
        await sleep(spd);
      }
      adjustOutputHeight();

      // between lines: if a new sequence has started (continuous), stop gracefully
      if (mode === 'continuous' && latestRenderSeq && latestRenderSeq !== activeSeq){
        animating = false;
        return;
      }
      await sleep(pause);
    }

    animating = false;
  });

  // ---------- draw helpers ----------
  function computeDrawDuration(picks, managers, spd, pause){
    let chars = 0;
    for (let i=0;i<Math.min(picks.length, managers.length);i++){
      chars += formatLine(managers[i], picks[i], TEAMS[picks[i]-1]||"??").length;
    }
    return chars*spd + managers.length*pause + 200;
  }

  async function writeDrawOnce(controller){
    if (TEAMS.length !== 265){
      out.textContent = `There should be exactly 265 NCAAF D1 teams. There are currently ${TEAMS.length} teams in the list.`;
      if (MANAGERS.length !== 12){
        out.textContent += `\nThere should be exactly 12 managers. There are currently ${MANAGERS.length} managers in the list.`;
      }
      adjustOutputHeight();
      return 0;
    }
    if (MANAGERS.length !== 12){
      out.textContent = `There should be exactly 12 managers. There are currently ${MANAGERS.length} managers in the list.`;
      adjustOutputHeight();
      return 0;
    }
    const picks = pick12(TEAMS.length);
    const managers = shuffle(MANAGERS);
    const speedSnap = globalSpeedMs;
    const pauseSnap = globalLinePauseMs;
    const duration = computeDrawDuration(picks, managers, speedSnap, pauseSnap);
    const renderSeq = Date.now();
    await update(ref(db,'state'), {
      running:true, mode:'once', controllerUid:controller,
      picks, managers, renderSeq, fastForward:false,
      speedMsSnapshot: speedSnap, linePauseMsSnapshot: pauseSnap
    });
    return duration;
  }

  async function writeBeginCycle(controller){
    if (TEAMS.length !== 265 || MANAGERS.length !== 12) return 0;
    const picks = pick12(TEAMS.length);
    const managers = shuffle(MANAGERS);
    const speedSnap = globalSpeedMs;
    const pauseSnap = globalLinePauseMs;
    const duration = computeDrawDuration(picks, managers, speedSnap, pauseSnap);
    const renderSeq = Date.now();
    await update(ref(db,'state'), {
      running:true, mode:'continuous', controllerUid:controller,
      picks, managers, renderSeq, fastForward:false,
      speedMsSnapshot: speedSnap, linePauseMsSnapshot: pauseSnap,
      hasBegun: true
    });
    return duration;
  }

  async function finishAndCooldown(){
    const now = Date.now();
    // return roles to host for executor/finalizer
    const r = await get(ref(db,'roles')); const val = r.exists()? r.val():{};
    const hostUid = val.hostUid || null;

    await update(ref(db,'state'), {
      running:false, finalizeRequested:false, finalizedAt: now,
      cooldownUntil: now + 60000, controlMode:'drawonce', fastForward:false,
      hasBegun: false
    });

    if (hostUid){
      await update(ref(db,'roles'), {
        executorUid: hostUid,
        finalizerUid: hostUid
      });
    }
  }

  // ---------- buttons ----------
  // Start â†’ controlMode 'begin' (host only). Confirm only if finalized exists.
  startBtn.addEventListener('click', async ()=>{
    if (startBtn.disabled) return;
    const st = (await get(ref(db,'state'))).val()||{};
    if (st.finalizedAt){
      if (!confirm("This will clear your finalized results, are you sure you want to continue?")) return;
      await update(ref(db,'state'), { finalizedAt: null, cooldownUntil: null });
    }
    await update(ref(db,'state'), { controlMode:'begin' });
  });

  // Begin â†’ continuous loop (Executor only)
  beginBtn.addEventListener('click', async ()=>{
    if (beginBtn.disabled) return;
    if (localContinuous) return;

    beginBtn.classList.add('on');
    localContinuous = true;
    localFinalizeRequested = false;

    const loop = async ()=>{
      const dur = await writeBeginCycle(myUID);
      if (!dur){ localContinuous=false; beginBtn.classList.remove('on'); return; }
      await sleep(dur);
      if (localFinalizeRequested){
        const dur2 = await writeBeginCycle(myUID);
        await sleep(dur2);
        localContinuous=false; beginBtn.classList.remove('on');
        await finishAndCooldown();
        return;
      }
      if (localContinuous) loop();
    };
    loop();
  });

  // Draw Once â†’ start; if already running once -> fast-forward to finish immediately.
  // Confirm only if finalized exists AND we're about to start a new draw.
  drawOnceBtn.addEventListener('click', async ()=>{
    const s = (await get(ref(db,'state'))).val()||{};
    const runningOnce = !!s.running && s.mode==='once';

    if (!runningOnce){
      if (s.finalizedAt){
        if (!confirm("This will clear your finalized results, are you sure you want to continue?")) return;
        await update(ref(db,'state'), { finalizedAt: null, cooldownUntil: null });
      }
      const dur = await writeDrawOnce(myUID);
      if (!dur) return;
      // Disable Start/Begin during a one-off
      startBtn.disabled = true;
      beginBtn.disabled = true;

      await sleep(dur);
      // If it wasnâ€™t fast-forwarded, close it cleanly
      const finish = (await get(ref(db,'state'))).val()||{};
      if (finish.running && !finish.fastForward && finish.mode==='once'){
        const cyc = (finish.cyclesCompleted||0)+1;
        await update(ref(db,'state'), { running:false, cyclesCompleted:cyc });
      }
    } else {
      // already running once -> request fast-forward (all clients will finish instantly)
      await update(ref(db,'state'), { fastForward:true });
    }
  });

  // Finalize
  finalizeBtn.addEventListener('click', async ()=>{
    if (finalizeBtn.disabled) return;
    finalizeBtn.classList.add('finalizing');
    const s = (await get(ref(db,'state'))).val()||{};
    if (s.mode==='continuous' && s.running){
      localFinalizeRequested = true;
      await update(ref(db,'state'), { finalizeRequested:true });
    } else {
      if (s.running && s.mode==='once'){
        // If a one-off is still typing and someone pressed Finalize, just fast-forward it first.
        await update(ref(db,'state'), { fastForward:true });
        // Wait until running flips false
        while(true){
          const cur = (await get(ref(db,'state'))).val()||{};
          if (!cur.running) break;
          await sleep(150);
        }
      }
      await finishAndCooldown();
      finalizeBtn.classList.remove('finalizing');
    }
  });

  // Clear (host-only). Disabled during Draw Once, during begin/hasBegun, and until cooldown ends.
  clearBtn.addEventListener('click', async ()=>{
    if (clearBtn.disabled) return;
    const st = (await get(ref(db,'state'))).val()||{};
    if (st.finalizedAt){
      if (!confirm("This will clear your finalized results, are you sure you want to continue?")) return;
    }
    await update(ref(db,'state'), {
      picks:null, managers:null, running:false, mode:null, controlMode:'drawonce',
      fastForward:false, cyclesCompleted:0, renderSeq:null, finalizedAt:null,
      cooldownUntil:null, hasBegun:false
    });
    out.textContent = "";
    adjustOutputHeight();
  });

  // Copy / CSV
  copyBtn.addEventListener('click', async ()=>{
    await navigator.clipboard.writeText(out.textContent);
    statusEl.textContent='Output copied'; setTimeout(()=>statusEl.textContent='',1500);
  });
  csvBtn.addEventListener('click', ()=>{
    const lines = out.textContent.trim().split('\n').slice(1).filter(x=>x.includes('->'));
    const rows = lines.map(line=>{
      const [left,right] = line.split('->').map(s=>s.trim());
      const [num, ...teamParts] = right.split(' - ');
      const team = teamParts.join(' - ');
      return `"${left}","${num}","${team}"`;
    }).join('\n');
    const csv = "Manager,TeamNumber,Team\n"+rows+"\n";
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='assignments.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Hotkeys
  document.addEventListener('keydown', (e)=>{
    if (e.code==='Space'){ e.preventDefault(); if (!beginBtn.disabled) beginBtn.click(); }
    if (e.key.toLowerCase()==='r'){ e.preventDefault(); if (!drawOnceBtn.disabled) drawOnceBtn.click(); }
  });

  // Data guard messages (your requested wording)
  if (TEAMS.length !== 265) { out.textContent = `There should be exactly 265 NCAAF D1 teams. There are currently ${TEAMS.length} teams in the list.`; }
  if (MANAGERS.length !== 12){ out.textContent += `\nThere should be exactly 12 managers. There are currently ${MANAGERS.length} managers in the list.`; }
  adjustOutputHeight();
</script>
</body>
</html>
