<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Randomly Assign NCAAF D1 Teams</title>
<style>
  :root { --bg:#0b1020; --card:#141a2e; --text:#e8ebff; --muted:#a9afd1; --accent:#7aa2ff; --ok:#79ffa1; --warn:#ffd479; --bad:#ff7a7a; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1300px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 14px;font-size:28px;text-align:center}

  .grid{display:grid;grid-template-columns: 1fr 1fr; gap:14px}
  @media(max-width:1100px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:12px;color:#a9afd1}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}

  /* Managers */
  .box-managers{border:1px solid #2a3252;border-radius:10px;padding:10px;background:#0f1530}
  ul.managers{margin:0;padding-left:20px;line-height:1.4}
  ul.managers li{margin:2px 0}

  /* Teams (scroll inside card) */
  .box-teams{height:34vh;overflow:auto;border:1px solid #2a3252;border-radius:10px;padding:10px;background:#0f1530}
  ol.teamlist{margin:0;padding-left:36px;line-height:1.25; white-space:nowrap}
  ol.teamlist li{padding:2px 6px;border-radius:8px; list-style: decimal}
  ol.teamlist li.hit{background:rgba(122,162,255,.18);outline:1px solid rgba(122,162,255,.35);font-weight:600}
  ol.teamlist li.omitted{color:var(--bad); text-decoration: line-through}

  /* Omitted Teams panel */
  .wide{grid-column: 1 / span 2;}
  .omitRow{display:grid; grid-template-columns:1fr; gap:12px}
  .omitBox{background:#0f1530;border:1px solid #2a3252;border-radius:10px;padding:10px}
  .omitBox textarea{width:100%; min-height:90px; background:#0c1230; color:var(--text); border:1px solid #2a3252; border-radius:8px; padding:8px; resize:vertical; font-family:ui-monospace,Consolas,Menlo,monospace}

  /* Output (two equal columns) */
  .outGrid{display:grid;grid-template-columns:1fr 1fr; gap:12px}
  .outBox{
    font-family:ui-monospace,Consolas,Menlo,monospace;
    background:#0f1530;border:1px solid #2a3252;border-radius:10px;
    padding:12px;overflow:auto;white-space:pre; /* no wrap; allow horizontal scroll */
  }
  .outTitle{margin-bottom:6px;color:var(--muted);font-size:13px}

  /* Footer controls */
  .controlsFooter{margin-top:8px;background:#0f1530;border:1px solid #2a3252;border-radius:12px;padding:10px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;justify-content:center}
  .btn{background:#1d2544;color:var(--text);border:1px solid #2a3252;border-radius:10px;padding:10px 14px;cursor:pointer;transition:.15s transform ease,.15s opacity ease}
  .btn:hover{transform:translateY(-1px);opacity:.95}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.primary{background:var(--accent);color:#0a0e1f;border-color:#5b86ff}
  .btn.on{outline:2px solid var(--ok);box-shadow:0 0 0 4px rgba(121,255,161,.12) inset}
  .btn.finalizing{outline:2px solid var(--warn);box-shadow:0 0 0 4px rgba(255,212,121,.12) inset}

  /* Host-only speed controls */
  #speedRow{display:none;margin-top:10px}
  .row{display:flex;gap:12px}
  .pill{background:#101736;border:1px solid #2a3252;padding:8px 10px;border-radius:10px}

  .countdown{font-weight:700;color:var(--warn)}
  .center{ text-align:center }
</style>
</head>
<body>
<div class="wrap">
  <h1>Randomly Assign NCAAF D1 Teams</h1>

  <!-- Top: Managers + Teams -->
  <div class="grid">
    <div class="card">
      <div class="muted">Managers</div>
      <div class="box-managers">
        <ul id="managersList" class="managers"></ul>
      </div>

      <!-- Host-only global speed -->
      <div id="speedRow" class="row">
        <div class="pill" style="flex:1">
          <div class="muted">Speed (ms/char)</div>
          <input id="speed" type="range" min="5" max="120" value="30" style="width:100%"/>
        </div>
        <div class="pill" style="flex:1">
          <div class="muted">Pause between lines (ms)</div>
          <input id="linePause" type="number" min="0" value="250" style="width:100%"/>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted">12 of 265 NCAAF D1 teams will be randomly selected.</div>
      <div class="box-teams">
        <ol id="teamList" class="teamlist mono"></ol>
      </div>
    </div>
  </div>

  <!-- Middle: Omitted Teams (host edits, viewable to all) -->
  <div class="card wide">
    <div class="muted">Omitted Teams (host only; separate teams with “;”)</div>
    <div class="omitRow">
      <div class="omitBox">
        <textarea id="omitText" placeholder="Example: Villanova University; University of Utah; ..."></textarea>
        <div class="small" id="omitHelp">Omitted teams will be struck out in red in the list and will not be assigned.</div>
      </div>
    </div>
  </div>

  <!-- Bottom: Output (two panes) -->
  <div class="card wide">
    <div class="muted">Output <span id="cooldown" class="countdown"></span></div>
    <div class="outGrid">
      <div>
        <div class="outTitle">Last Completed Draw</div>
        <div id="outPrev" class="outBox"></div>
      </div>
      <div>
        <div class="outTitle">Live (Randomly assigning teams....)</div>
        <div id="outLive" class="outBox"></div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="controlsFooter">
    <div class="controls">
      <button id="start"    class="btn">Start</button>
      <button id="begin"    class="btn primary" disabled>Begin</button>
      <button id="drawOnce" class="btn">Draw Once</button>
      <button id="finalize" class="btn" disabled>Finalize</button>
      <button id="clear"    class="btn" style="display:none">Clear</button>
      <button id="copy"     class="btn">Copy</button>
      <button id="csv"      class="btn">Export CSV</button>
    </div>
    <div class="small center" id="status">Connecting…</div>
    <div class="small center" id="audience"></div>
    <!--<div class="small center">Hotkeys: <b>Space</b> Begin/stop (Executor) • <b>R</b> Draw Once</div>-->
  </div>
</div>

<script type="module">
  /* ===================== FIXED DATA ===================== */
  // Paste your exact 265-name list here (must be 265).
  const TEAMS = [
"Abilene Christian University","Alabama A&M University","Alabama State University","Alcorn State University","Appalachian State University","Arizona State University",
  "Arkansas State University","Auburn University","Austin Peay State University","Ball State University","Baylor University","Bethune-Cookman University",
  "Boise State University","Boston College","Bowling Green State University","Brigham Young University","Brown University","Bryant University",
  "Bucknell University","Butler University","California Polytechnic State University – San Luis Obispo","California State University – Fresno","California State University – Sacramento",
  "Campbell University","Central Connecticut State University","Central Michigan University","Charleston Southern University","Clemson University",
  "Coastal Carolina University","Colgate University","College of the Holy Cross","Colorado State University","Columbia University","Cornell University",
  "Cottey College","Dartmouth College","Davidson College","Delaware State University","Drake University","Duke University","Duquesne University",
  "East Carolina University","East Tennessee State University","Eastern Illinois University","Eastern Kentucky University","Eastern Michigan University",
  "Eastern Washington University","Elon University","Florida A&M University","Florida Atlantic University","Florida International University","Florida State University",
  "Fordham University","Formerly Dixie State University","Furman University","Gardner-Webb University","Georgetown University","Georgia Southern University",
  "Georgia State University","Georgia Tech","Grambling State University","Hampton University","Harvard University","Houston Christian University","Howard University",
  "Idaho State University","Illinois State University","Indiana State University","Indiana University","Iowa State University","Jackson State University","Jacksonville State University",
  "James Madison University","Kansas State University","Kennesaw State University","Kent State University","Lafayette College","Lamar University","Lehigh University",
  "Liberty University","Lindenwood University","Long Island University","Louisiana State University (LSU)","Louisiana Tech University","Marist College","Marshall University",
  "McNeese State University","Mercer University","Mercyhurst University","Merrimack College","Miami University","Michigan State University","Middle Tennessee State University",
  "Mississippi State University","Mississippi Valley State University","Missouri State University","Monmouth University","Montana State University","Morehead State University",
  "Morgan State University","Murray State University","New Mexico State University","Nicholls State University","Norfolk State University","North Carolina A&T State University",
  "North Carolina Central University","North Carolina State University","North Dakota State University","Northern Arizona University","Northern Illinois University",
  "Northwestern State University of Louisiana","Northwestern University","Ohio State University","Ohio University","Oklahoma State University","Old Dominion University",
  "Oregon State University","Penn State","Portland State University","Prairie View A & M University","Presbyterian College","Princeton University","Purdue University",
  "Rice University","Robert Morris University – Pennsylvania","Rutgers University","Sacred Heart University","Saint Francis University","Sam Houston State University",
  "Samford University","San Diego State University","San Jose State University","South Carolina State University","South Dakota State University","Southeast Missouri State University",
  "Southeastern Louisiana University","Southern Illinois University Carbondale","Southern Methodist University – SMU","Southern University & A&M College","Southern Utah University",
  "Stanford University","Stephen F Austin State University","Stetson University","Stonehill College","SUNY Stony Brook University","SUNY University at Albany","SUNY University at Buffalo",
  "Syracuse University","Tarleton State University","Temple University","Tennessee State University","Tennessee Technological University","Texas A&M University","Texas A&M University – Commerce",
  "Texas Christian University","Texas Southern University","Texas State University","Texas Tech University","The Citadel","Towson University","Troy University","Tulane University",
  "United States Air Force Academy","United States Military Academy","United States Naval Academy","University of Akron","University of Alabama","University of Alabama – Birmingham",
  "University of Arizona","University of Arkansas","University of Arkansas at Pine Bluff","University of California – Berkeley","University of California – Davis",
  "University of California – Los Angeles – UCLA","University of Central Arkansas","University of Central Florida","University of Cincinnati","University of Colorado – Boulder",
  "University of Connecticut","University of Dayton","University of Delaware","University of Florida","University of Georgia","University of Hawaii at Manoa","University of Houston",
  "University of Idaho","University of Illinois","University of Iowa","University of Kansas","University of Kentucky","University of Louisiana","University of Louisiana – Monroe",
  "University of Louisville","University of Maine","University of Maryland","University of Massachusetts – Amherst","University of Memphis","University of Miami","University of Michigan",
  "University of Minnesota","University of Mississippi","University of Missouri","University of Montana","University of Nebraska","University of Nevada – Las Vegas","University of Nevada – Reno",
  "University of New Hampshire","University of New Mexico","University of North Alabama","University of North Carolina at Chapel Hill","University of North Carolina at Charlotte",
  "University of North Dakota","University of North Texas","University of Northern Colorado","University of Northern Iowa","University of Notre Dame","University of Oklahoma",
  "University of Oregon","University of Pennsylvania – Penn","University of Pittsburgh","University of Rhode Island","University of Richmond","University of San Diego",
  "University of South Alabama","University of South Carolina","University of South Dakota","University of South Florida","University of Southern California","University of Southern Mississippi",
  "University of St. Thomas – Minnesota","University of Tennessee","University of Tennessee – Chattanooga","University of Tennessee – Martin","University of Texas – Austin",
  "University of Texas – El Paso","University of Texas – Rio Grande Valley","University of Texas – San Antonio","University of the Incarnate Word","University of Toledo",
  "University of Tulsa","University of Utah","University of Virginia","University of Washington","University of West Georgia","University of Wisconsin","University of Wyoming",
  "Utah State University","Valparaiso University","Vanderbilt University","Villanova University","Virginia Military Institute – VMI","Virginia Tech","Wagner College","Wake Forest University",
  "Washington State University","Weber State University","West Virginia University","Western Carolina University","Western Illinois University","Western Kentucky University",
  "Western Michigan University","William & Mary","Wofford College","Yale University","Youngstown State University"            
];

  // Managers (12) — DA -> DS
  const MANAGERS = ["AP","AW","CR","JW","MS","LL","Josh","FAB","JJ","EJ","DS","CO"];
  /* ===================================================== */

  // ---------- Firebase (CDN) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getDatabase, ref, onValue, get, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAmgCkDpIN-YNALQOb8HTb7WJn1bX0i9qA",
    authDomain: "draft-sync.firebaseapp.com",
    databaseURL: "https://draft-sync-default-rtdb.firebaseio.com",
    projectId: "draft-sync",
    storageBucket: "draft-sync.firebasestorage.app",
    messagingSenderId: "234722685207",
    appId: "1:234722685207:web:abc660fa65a105ecdbc752"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getDatabase(app);

  // ---------- UI refs ----------
  const outPrev = document.getElementById('outPrev');
  const outLive = document.getElementById('outLive');
  const teamList = document.getElementById('teamList');
  const managersList = document.getElementById('managersList');
  const statusEl = document.getElementById('status');
  const audEl = document.getElementById('audience');
  const speedRow = document.getElementById('speedRow');
  const speedEl = document.getElementById('speed');
  const pauseEl = document.getElementById('linePause');
  const startBtn = document.getElementById('start');
  const beginBtn = document.getElementById('begin');
  const drawOnceBtn = document.getElementById('drawOnce');
  const finalizeBtn = document.getElementById('finalize');
  const clearBtn = document.getElementById('clear');
  const copyBtn = document.getElementById('copy');
  const csvBtn = document.getElementById('csv');
  const cooldownEl = document.getElementById('cooldown');
  const omitText = document.getElementById('omitText');

  // ---------- helpers ----------
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  function shuffle(a){ a=a.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j]]=[a[j],a[i]][1]; } return a; } // swap trick
  function pad3(n){ return String(n).padStart(3,' '); }
  const formatLine = (m, num, team)=>`${m.padEnd(10)} -> ${pad3(num)} - ${team}\n`;

  // pick N from allowed indices
  function pickNFromAllowed(allowedIdx, n){
    if (allowedIdx.length < n) return null;
    const arr = shuffle(allowedIdx).slice(0, n).sort((a,b)=>a-b);
    return arr;
  }

  // Parse omitted as semicolon-separated; trims spaces
  function parseOmitted(text){
    const raw = (text||'').split(';').map(s=>s.trim()).filter(Boolean);
    return raw;
  }

  // map name to team index (exact match)
  const teamIndexByName = new Map(TEAMS.map((t,i)=>[t, i+1]));

  function validateOmittedNames(list){
    const mismatches = [];
    for (const name of list){
      if (!teamIndexByName.has(name)) mismatches.push(name);
    }
    return mismatches;
  }

  function allowedIndicesFromOmitted(list){
    const omitSet = new Set(list.map(name=>teamIndexByName.get(name))); // numbers
    const allowed = [];
    for (let i=1;i<=TEAMS.length;i++){
      if (!omitSet.has(i)) allowed.push(i);
    }
    return {allowed, omitSet};
  }

  // update teams list strike-through styles
  function renderTeamStrikes(omitSet){
    document.querySelectorAll('#teamList li').forEach(li=>{
      const num = Number(li.getAttribute('data-num'));
      if (omitSet.has(num)) { li.classList.add('omitted'); }
      else { li.classList.remove('omitted'); }
    });
  }

  // Render static lists
  managersList.innerHTML = MANAGERS.map(m=>`<li>${m}</li>`).join('');
  teamList.innerHTML = TEAMS.map((t,i)=> `<li data-num="${i+1}">${t}</li>`).join('');

  // ---------- global state ----------
  let myUID=null, myName="Viewer";
  let isHost=false, isExecutor=false, isFinalizer=false;
  let globalSpeedMs=30, globalLinePauseMs=250;
  let localIsController=false;
  let localContinuous=false;
  let localFinalizeRequested=false;
  let fastForward = false;
  let hasBegun = false;

  // renderer guards
  let animating = false;
  let activeSeq = null;

  // cooldown timer
  let cooldownTimer = null;

  // ---------- auth ----------
  onAuthStateChanged(auth, async (user)=>{
    if (!user){ await signInAnonymously(auth); return; }
    myUID = user.uid;
    await ensureDisplayName();
    await bootstrapHostIfNamed();
    await readMyRole();
    statusEl.textContent = `${(isHost?'HOST':isExecutor?'EXECUTOR':isFinalizer?'FINALIZER':'VIEWER')}: ${myName} (${myUID.slice(0,8)}…)`;
    wireUIForRole();
  });

  async function ensureDisplayName(){
    const s = await get(ref(db, `users/${myUID}`));
    const existing = s.exists() ? s.val().displayName : null;
    if (existing){ myName = existing; return; }
    let name = (prompt("Enter your name or initials:")||"").trim().slice(0,24);
    if (!name) name="Viewer";
    await set(ref(db, `users/${myUID}`), { displayName: name, joinedAt: Date.now() });
    myName = name;
  }

  async function bootstrapHostIfNamed(){
    const rolesSnap = await get(ref(db,'roles'));
    const rolesVal = rolesSnap.exists()? rolesSnap.val():{};
    const noneSet = !rolesVal || (!rolesVal.hostUid && !rolesVal.executorUid && !rolesVal.finalizerUid);
    if (myName === "AceDaAdmin" && noneSet){
      await runTransaction(ref(db,'roles'), (cur)=>{
        if (cur && (cur.hostUid || cur.executorUid || cur.finalizerUid)) return;
        return { hostUid: myUID, executorUid: myUID, finalizerUid: myUID };
      });
    }
  }

  async function readMyRole(){
    const r = await get(ref(db,`roles`)); const val = r.exists()? r.val():{};
    isHost = val.hostUid === myUID;
    isExecutor = val.executorUid === myUID;
    isFinalizer = val.finalizerUid === myUID;
  }

  function wireUIForRole(){
    startBtn.disabled = !isHost;
    beginBtn.disabled = true;
    finalizeBtn.disabled = true;
    drawOnceBtn.disabled = false;
    clearBtn.style.display = isHost ? '' : 'none';
    speedRow.style.display = isHost ? '' : 'none';
    omitText.disabled = !isHost; // only host can edit
  }

  // Roles & settings listeners
  onValue(ref(db,'roles'), (snap)=>{
    const val = snap.val()||{};
    isHost = val.hostUid === myUID;
    isExecutor = val.executorUid === myUID;
    isFinalizer = val.finalizerUid === myUID;
    clearBtn.style.display = isHost ? '' : 'none';
    speedRow.style.display = isHost ? '' : 'none';
    omitText.disabled = !isHost;
  });

  onValue(ref(db,'settings'), (snap)=>{
    const s = snap.val()||{};
    if (typeof s.speedMs === 'number') globalSpeedMs = s.speedMs;
    if (typeof s.linePauseMs === 'number') globalLinePauseMs = s.linePauseMs;
    if (isHost){ speedEl.value = globalSpeedMs; pauseEl.value = globalLinePauseMs; }
  });
  const saveGlobalSpeed = ()=>{ if (!isHost) return; update(ref(db,'settings'), {
    speedMs: Number(speedEl.value||30), linePauseMs: Number(pauseEl.value||250)
  }); };
  speedEl.addEventListener('change', saveGlobalSpeed);
  pauseEl.addEventListener('change', saveGlobalSpeed);

  // Persist omitted text (host updates)
  omitText.addEventListener('change', async ()=>{
    if (!isHost || omitText.disabled) return;
    await update(ref(db,'state'), { omittedTeamsText: omitText.value });
  });
  // Mirror omitted from DB to UI, and strike teams
  onValue(ref(db,'state/omittedTeamsText'), (snap)=>{
    const txt = snap.val()||'';
    if (omitText.value !== txt) omitText.value = txt;
    const list = parseOmitted(txt);
    const {omitSet} = allowedIndicesFromOmitted(list);
    renderTeamStrikes(omitSet);
  });

  // Users list
  onValue(ref(db,'users'), (snap)=>{
    const users = snap.val()||{};
    const list = Object.entries(users).map(([uid,u])=>`${(u.displayName||'Viewer')} — ${uid.slice(0,8)}…`);
    audEl.textContent = 'Connected: ' + (list.length ? list.join(' | ') : '—');
  });

  // ---------- UI state & gating ----------
  onValue(ref(db,'state'), async (snap)=>{
    const s = snap.val()||{};
    const now = Date.now();
    const until = s.cooldownUntil||0;

    fastForward = !!s.fastForward;
    hasBegun = !!s.hasBegun;

    // Last Completed Draw
    const lastText = s.lastResultText || '';
    if (outPrev.textContent !== lastText){ outPrev.textContent = lastText; }

    // Cooldown & disable regions
    if (now < until){
      if (!cooldownTimer){
        const tick = ()=>{
          const n = Date.now();
          const secs = Math.max(0, Math.ceil((until - n)/1000));
          cooldownEl.textContent = ` — Finalized. Controls unlock in ${secs}s`;
          if (n >= until){
            cooldownEl.textContent='';
            clearInterval(cooldownTimer);
            cooldownTimer = null;
            wireUIForRole();
          }
        };
        cooldownTimer = setInterval(tick, 500);
        tick();
      }
      startBtn.disabled = beginBtn.disabled = drawOnceBtn.disabled = finalizeBtn.disabled = clearBtn.disabled = true;
      omitText.disabled = true; // lock omitted during cooldown
    } else {
      cooldownEl.textContent='';
      const mode = s.controlMode || 'drawonce';
      const running = !!s.running;
      const runningOnce = running && s.mode === 'once';
      const controllerUid = s.controllerUid;

      // highlights
      document.querySelectorAll('#teamList li.hit').forEach(li=>li.classList.remove('hit'));
      (Array.isArray(s.picks)? s.picks:[]).forEach(n=>{
        const li = document.querySelector(`#teamList li[data-num="${n}"]`);
        if (li) li.classList.add('hit');
      });

      // Base gating
      startBtn.disabled   = !isHost || runningOnce || running;
      beginBtn.disabled   = !(mode === 'begin' && isExecutor) || runningOnce || running;
      drawOnceBtn.disabled= (mode === 'begin') && !runningOnce ? true : false;
      if (runningOnce) drawOnceBtn.disabled = false; // allow fast-forward
      // Finalize only after Begin
      finalizeBtn.disabled = !(hasBegun && isFinalizer) || runningOnce;
      // Clear: disabled after Start (hasBegun true) and during Draw Once
      clearBtn.disabled = !isHost || runningOnce || mode === 'begin' || hasBegun;

      // Omitted editor lock: editable only for host & only when Start is available and not running
      omitText.disabled = !isHost || runningOnce || mode === 'begin' || hasBegun;

      // controller tracking
      localIsController = (controllerUid === myUID);

      if (!s.running){
        localContinuous=false; localFinalizeRequested=false;
        beginBtn.classList.remove('on'); finalizeBtn.classList.remove('finalizing');
      }
    }
  });

  // ---------- Renderer (Live typing; controller acks completion; Draw Once can fast-forward mid-line) ----------
  onValue(ref(db,'state'), async (snap)=>{
    const s = snap.val()||{};
    const running   = !!s.running;
    const picks     = Array.isArray(s.picks) ? s.picks : [];
    const managers  = Array.isArray(s.managers) ? s.managers : [];
    const renderSeq = s.renderSeq ?? null;
    const mode      = s.mode || 'once';
    const spd       = typeof s.speedMsSnapshot === 'number' ? s.speedMsSnapshot : (await get(ref(db,'settings'))).val()?.speedMs ?? 30;
    const pause     = typeof s.linePauseMsSnapshot === 'number' ? s.linePauseMsSnapshot : (await get(ref(db,'settings'))).val()?.linePauseMs ?? 250;
    localIsController = (s.controllerUid === myUID);

    if (!running || !picks.length || !managers.length) return;
    if (animating) return;
    if (renderSeq && renderSeq === activeSeq) return;

    animating = true;
    activeSeq = renderSeq;
    outLive.textContent = "";

    // Fast-forward immediately at start (for once-mode)
    if (fastForward && mode === 'once'){
      const block = picks.map((p,i)=>formatLine(managers[i], p, TEAMS[p-1]||"??")).join('');
      outLive.textContent = block;
      if (localIsController){
        await update(ref(db,'state'), {
          running:false, fastForward:false,
          lastCompletedSeq: renderSeq,
          lastResultText: outLive.textContent,
          cyclesCompleted: (s.cyclesCompleted||0)+1
        });
      }
      animating = false; return;
    }

    // Normal typing, with mid-line fast-forward for once-mode
    for (let i=0;i<Math.min(picks.length, managers.length);i++){
      const idx = picks[i]-1;
      const line = formatLine(managers[i], picks[i], TEAMS[idx] || "??");
      for (let j=0;j<line.length;j++){
        // mid-line fast-forward for once
        const ffSnap = (await get(ref(db,'state'))).val()?.fastForward;
        if (mode==='once' && ffSnap){
          const block = picks.map((p,k)=>formatLine(managers[k], p, TEAMS[p-1]||"??")).join('');
          outLive.textContent = block;
          if (localIsController){
            const cur = (await get(ref(db,'state'))).val()||{};
            await update(ref(db,'state'), {
              running:false, fastForward:false,
              lastCompletedSeq: renderSeq,
              lastResultText: outLive.textContent,
              cyclesCompleted: (cur.cyclesCompleted||0)+1
            });
          }
          animating = false; return;
        }
        outLive.textContent += line[j];
        await sleep(spd);
      }
      await sleep(pause);
    }

    // Finished: controller acks & stores Last Completed Draw
    if (localIsController){
      await update(ref(db,'state'), {
        lastCompletedSeq: renderSeq,
        lastResultText: outLive.textContent
      });
      if (mode === 'once'){
        await update(ref(db,'state'), {
          running:false,
          cyclesCompleted: (s.cyclesCompleted||0)+1
        });
      }
    }

    animating = false;
  });

  // ---------- Begin loop (handshake) ----------
  async function runBeginLoop(){
    if (localContinuous) return;
    localContinuous = true; beginBtn.classList.add('on');
    localFinalizeRequested = false;

    while (localContinuous){
      const seqInfo = await startOneCycleContinuous();
      if (!seqInfo) break;
      await waitForSeqCompletion(seqInfo.renderSeq);

      if (localFinalizeRequested){
        const finalInfo = await startOneCycleContinuous();
        if (finalInfo) await waitForSeqCompletion(finalInfo.renderSeq);
        localContinuous=false; beginBtn.classList.remove('on');
        await finishAndCooldown();
        break;
      }
    }
  }

  async function startOneCycleContinuous(){
    if (TEAMS.length !== 265 || MANAGERS.length !== 12) return null;

    // Build allowed set from omitted
    const omitTxt = (await get(ref(db,'state/omittedTeamsText'))).val()||'';
    const list = parseOmitted(omitTxt);
    const mismatches = validateOmittedNames(list);
    // For Begin we assume validation already happened at Start; but still safe:
    if (mismatches.length){
      outLive.textContent = "Omitted list contains unknown team names:\n- " + mismatches.join('\n- ');
      return null;
    }
    const {allowed} = allowedIndicesFromOmitted(list);
    const picks = pickNFromAllowed(allowed, 12);
    if (!picks){
      outLive.textContent = "Not enough available teams to assign 12.\nReduce omitted teams.";
      return null;
    }
    const managers = shuffle(MANAGERS);
    const settings = (await get(ref(db,'settings'))).val() || {};
    const speedSnap = Number(settings.speedMs ?? globalSpeedMs);
    const pauseSnap = Number(settings.linePauseMs ?? globalLinePauseMs);
    const renderSeq = Date.now();
    await update(ref(db,'state'), {
      running:true, mode:'continuous', controlMode:'begin',
      controllerUid: myUID, hasBegun:true,
      picks, managers, renderSeq, fastForward:false,
      speedMsSnapshot: speedSnap, linePauseMsSnapshot: pauseSnap
    });
    return { renderSeq };
  }

  async function waitForSeqCompletion(seq){
    while (true){
      const s = (await get(ref(db,'state'))).val()||{};
      if (s.lastCompletedSeq === seq) return;
      await sleep(120);
    }
  }

  // ---------- Draw Once ----------
  async function writeDrawOnce(){
    if (TEAMS.length !== 265){
      outLive.textContent = `There should be exactly 265 NCAAF D1 teams. There are currently ${TEAMS.length} teams in the list.`;
      if (MANAGERS.length !== 12){
        outLive.textContent += `\nThere should be exactly 12 managers. There are currently ${MANAGERS.length} managers in the list.`;
      }
      return false;
    }
    if (MANAGERS.length !== 12){
      outLive.textContent = `There should be exactly 12 managers. There are currently ${MANAGERS.length} managers in the list.`;
      return false;
    }
    // Validate omitted BEFORE running
    const omitTxt = (await get(ref(db,'state/omittedTeamsText'))).val()||'';
    const list = parseOmitted(omitTxt);
    const mismatches = validateOmittedNames(list);
    if (mismatches.length){
      alert("These omitted names do not match any team:\n- " + mismatches.join('\n- '));
      return false;
    }
    const {allowed} = allowedIndicesFromOmitted(list);
    const picks = pickNFromAllowed(allowed, 12);
    if (!picks){
      alert("Not enough available teams to assign 12.\nReduce omitted teams.");
      return false;
    }

    const managers = shuffle(MANAGERS);
    const settings = (await get(ref(db,'settings'))).val() || {};
    const speedSnap = Number(settings.speedMs ?? globalSpeedMs);
    const pauseSnap = Number(settings.linePauseMs ?? globalLinePauseMs);
    const renderSeq = Date.now();
    await update(ref(db,'state'), {
      running:true, mode:'once', controlMode:'drawonce',
      controllerUid: myUID,
      picks, managers, renderSeq, fastForward:false,
      speedMsSnapshot: speedSnap, linePauseMsSnapshot: pauseSnap
    });
    return true;
  }

  async function finishAndCooldown(){
    const now = Date.now();
    const r = await get(ref(db,'roles')); const val = r.exists()? r.val():{};
    const hostUid = val.hostUid || null;

    await update(ref(db,'state'), {
      running:false, finalizeRequested:false, finalizedAt: now,
      cooldownUntil: now + 60000, controlMode:'drawonce', fastForward:false,
      hasBegun: false
    });

    if (hostUid){
      await update(ref(db,'roles'), {
        executorUid: hostUid,
        finalizerUid: hostUid
      });
    }
  }

  // ---------- Buttons ----------
  // Start: enter Begin mode (host only). Validate omitted here.
  startBtn.addEventListener('click', async ()=>{
    if (startBtn.disabled) return;
    const st = (await get(ref(db,'state'))).val()||{};
    if (st.finalizedAt){
      if (!confirm("This will clear your finalized results, are you sure you want to continue?")) return;
      await update(ref(db,'state'), { finalizedAt: null, cooldownUntil: null });
    }
    // validate omitted
    const list = parseOmitted(omitText.value);
    const mismatches = validateOmittedNames(list);
    if (mismatches.length){
      alert("These omitted names do not match any team:\n- " + mismatches.join('\n- '));
      return;
    }
    await update(ref(db,'state'), { controlMode:'begin' });
    outLive.textContent = ""; // clear Live per your preference
  });

  // Begin (Executor) → deterministic loop
  beginBtn.addEventListener('click', async ()=>{
    if (beginBtn.disabled) return;
    localIsController = true;
    runBeginLoop();
  });

  // Draw Once with validation; second click fast-forwards
  drawOnceBtn.addEventListener('click', async ()=>{
    const s = (await get(ref(db,'state'))).val()||{};
    const runningOnce = !!s.running && s.mode==='once';

    if (!runningOnce){
      if (s.finalizedAt){
        if (!confirm("This will clear your finalized results, are you sure you want to continue?")) return;
        await update(ref(db,'state'), { finalizedAt: null, cooldownUntil: null });
      }
      // validate omitted
      const list = parseOmitted((await get(ref(db,'state/omittedTeamsText'))).val()||omitText.value||'');
      const mismatches = validateOmittedNames(list);
      if (mismatches.length){
        alert("These omitted names do not match any team:\n- " + mismatches.join('\n- '));
        return;
      }

      localIsController = true;
      const ok = await writeDrawOnce();
      if (ok){ startBtn.disabled = true; beginBtn.disabled = true; }
    } else {
      // request fast-forward
      await update(ref(db,'state'), { fastForward:true });
    }
  });

  // Finalize (Finalizer)
  finalizeBtn.addEventListener('click', async ()=>{
    if (finalizeBtn.disabled) return;
    finalizeBtn.classList.add('finalizing');
    const s = (await get(ref(db,'state'))).val()||{};
    if (s.mode==='continuous' && s.running){
      localFinalizeRequested = true;
      await update(ref(db,'state'), { finalizeRequested:true });
    } else {
      if (s.running && s.mode==='once'){
        await update(ref(db,'state'), { fastForward:true });
        while(true){
          const cur = (await get(ref(db,'state'))).val()||{};
          if (!cur.running) break;
          await sleep(150);
        }
      }
      await finishAndCooldown();
      finalizeBtn.classList.remove('finalizing');
    }
  });

  // Clear (host-only). Confirmation only if finalized exists.
  clearBtn.addEventListener('click', async ()=>{
    if (clearBtn.disabled) return;
    const st = (await get(ref(db,'state'))).val()||{};
    if (st.finalizedAt){
      if (!confirm("This will clear your finalized results, are you sure you want to continue?")) return;
    }
    await update(ref(db,'state'), {
      picks:null, managers:null, running:false, mode:null, controlMode:'drawonce',
      fastForward:false, cyclesCompleted:0, renderSeq:null, lastCompletedSeq:null,
      lastResultText:'', finalizedAt:null, cooldownUntil:null, hasBegun:false
    });
    outLive.textContent = "";
    outPrev.textContent = "";
  });

  // Copy / CSV (Live pane)
  copyBtn.addEventListener('click', async ()=>{
    await navigator.clipboard.writeText(outLive.textContent);
    statusEl.textContent='Output copied'; setTimeout(()=>statusEl.textContent='',1500);
  });
  csvBtn.addEventListener('click', ()=>{
    const lines = outLive.textContent.trim().split('\n').filter(x=>x.includes('->'));
    const rows = lines.map(line=>{
      const [left,right] = line.split('->').map(s=>s.trim());
      const [num, ...teamParts] = right.split(' - ');
      const team = teamParts.join(' - ');
      return `"${left}","${num}","${team}"`;
    }).join('\n');
    const csv = "Manager,TeamNumber,Team\n"+rows+"\n";
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='assignments.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  /*
  // Hotkeys
  document.addEventListener('keydown', (e)=>{
    if (e.code==='Space'){ e.preventDefault(); if (!beginBtn.disabled) beginBtn.click(); }
    if (e.key.toLowerCase()==='r'){ e.preventDefault(); if (!drawOnceBtn.disabled) drawOnceBtn.click(); }
  });*/

  // Guards on initial data
  if (TEAMS.length !== 265){
    outLive.textContent = `There should be exactly 265 NCAAF D1 teams. There are currently ${TEAMS.length} teams in the list.`;
  }
  if (MANAGERS.length !== 12){
    outLive.textContent += `\nThere should be exactly 12 managers. There are currently ${MANAGERS.length} managers in the list.`;
  }
</script>
</body>
</html>
